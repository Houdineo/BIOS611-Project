---
title: "R Notebook"
output: html_notebook
---

```{r}

library(tidyverse)
library(lubridate)
library(stringr)

```


```{r}

air <- read_csv("Air_Quality.csv")

clean_air <- air %>%
  janitor::clean_names() %>%
  mutate(
    start_date = mdy(start_date),
    time_period = as.factor(time_period),
    geo_place_name = as.factor(geo_place_name),
    name = as.factor(name),
    measure = as.factor(measure),
    data_value = as.numeric(data_value)
  ) %>%
  filter(!is.na(data_value))

```

```{r}

pollution3 <- clean_air %>%
  filter(
    str_detect(as.character(name), "NO2")   |
    str_detect(as.character(name), "PM2.5") |
    str_detect(as.character(name), "Ozone")
  )


```

```{r}

no2_three <- clean_air %>%
  filter(name == "Nitrogen dioxide (NO2)") %>%
  mutate(
    period_type = case_when(
      str_detect(time_period, "Winter") ~ "Winter average",
      str_detect(time_period, "Summer") ~ "Summer average",
      str_detect(time_period, "Annual") ~ "Annual average",
      TRUE ~ "Other"
    ),
    period_year = case_when(
      period_type == "Winter average" & month(start_date) == 12 ~ year(start_date) + 1L,
      TRUE ~ year(start_date)
    )
  ) %>%
  filter(period_type != "Other")

no2_three_summary <- no2_three %>%
  group_by(period_year, period_type) %>%
  summarize(mean_no2 = mean(data_value, na.rm = TRUE), .groups = "drop")

fig_no2_3lines <- ggplot(no2_three_summary,
                         aes(x = period_year, y = mean_no2, color = period_type)) +
  geom_line(linewidth = 0.9) +
  geom_point(size = 2) +
  geom_smooth(aes(group = 1), method = "loess", se = FALSE, color = "black") +
  scale_x_continuous(breaks = seq(min(no2_three_summary$period_year),
                                  max(no2_three_summary$period_year), by = 1)) +
  labs(
    title = "NO2 Seasonal and Annual Averages in NYC",
    subtitle = "Winter, summer, and annual averages by year | Black LOESS curve = long-term trend",
    x = "Year",
    y = "NO2 (ppb)",
    color = "Period type"
  )

fig_no2_3lines

```

```{r}

library(dplyr)
library(stringr)
library(lubridate)
library(ggplot2)

summer_ozone <- pollution3 %>%
  filter(str_detect(as.character(name), "Ozone")) %>%
  filter(str_detect(time_period, "^Summer")) %>%
  mutate(
    year = as.integer(str_extract(time_period, "\\d{4}"))
  ) %>%
  group_by(year) %>%
  summarize(mean_ozone = mean(data_value, na.rm = TRUE), .groups = "drop")

fig_summer_ozone <- ggplot(summer_ozone, aes(x = year, y = mean_ozone)) +
  geom_line(color = "black", linewidth = 0.9) +
  geom_point(color = "black", size = 2) +
  geom_smooth(
    method = "loess",
    se = FALSE,
    color = "blue",
    linewidth = 1.1
  ) +
  scale_x_continuous(breaks = seq(min(summer_ozone$year),
                                  max(summer_ozone$year), by = 1)) +
  labs(
    title = "Summer Ozone Levels in NYC (2009–2023)",
    subtitle = "Summer = peak ozone season | Blue LOESS curve = long-term trend",
    x = "Year",
    y = "Ozone (ppb)"
  )

fig_summer_ozone



```



```{r}

library(dplyr)
library(stringr)
library(ggplot2)

# 1. Filter to PM2.5 only
pm25_data <- pollution3 %>%
  filter(str_detect(as.character(name), "PM2.5"))

# 2. Average PM2.5 by neighborhood
pm25_neighborhood <- pm25_data %>%
  group_by(geo_place_name) %>%
  summarize(
    mean_pm25 = mean(data_value, na.rm = TRUE),
    n_obs = n()
  ) %>%
  drop_na(mean_pm25)

# 3. Take the top 10 neighborhoods
pm25_top10 <- pm25_neighborhood %>%
  slice_max(mean_pm25, n = 10)

# 4. Plot
fig_pm25_neighborhood <- ggplot(pm25_top10,
                                aes(x = reorder(geo_place_name, mean_pm25),
                                    y = mean_pm25)) +
  geom_col(fill = "red") +
  coord_flip() +
  labs(
    title = "Top 10 NYC Neighborhoods by Average PM2.5",
    subtitle = "Averages computed over all available years in the dataset",
    x = "Neighborhood",
    y = "PM2.5 (µg/m³)"
  ) +
  theme_minimal()

fig_pm25_neighborhood

```

```{r}

pm25_bottom10 <- pm25_neighborhood %>%
  slice_min(mean_pm25, n = 10)

fig_pm25_bottom10 <- ggplot(pm25_bottom10,
       aes(x = reorder(geo_place_name, mean_pm25), y = mean_pm25)) +
  geom_col(fill = "forestgreen") +
  coord_flip() +
  labs(
    title = "Bottom 10 NYC Neighborhoods by Average PM2.5",
    subtitle = "Averages computed over all available years in the dataset",
    x = "Neighborhood",
    y = "PM2.5 (µg/m³)"
  ) +
  theme_minimal()

fig_pm25_bottom10

```

```{r}

library(dplyr)
library(stringr)
library(tidyr)
library(ggplot2)
library(reshape2)

pollution_wide <- clean_air %>%
  filter(str_detect(as.character(name), "NO2") |
         str_detect(as.character(name), "PM2.5") |
         str_detect(as.character(name), "Ozone")) %>%
  mutate(
    pollutant = case_when(
      str_detect(as.character(name), "NO2")   ~ "NO2",
      str_detect(as.character(name), "PM2.5") ~ "PM2.5",
      str_detect(as.character(name), "Ozone") ~ "Ozone"
    )
  ) %>%
  group_by(geo_place_name, pollutant) %>%
  summarize(mean_value = mean(data_value, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(
    names_from  = pollutant,
    values_from = mean_value
  )

poll_cor <- pollution_wide %>%
  select(-geo_place_name) %>%
  cor(use = "pairwise.complete.obs")

poll_cor_long <- melt(poll_cor,
                      varnames = c("Pollutant1", "Pollutant2"),
                      value.name = "correlation")

fig_poll_cor <- ggplot(poll_cor_long,
                       aes(x = Pollutant1, y = Pollutant2, fill = correlation)) +
  geom_tile() +
  geom_text(aes(label = round(correlation, 2)), color = "white", size = 4) +
  scale_fill_gradient2(limits = c(-1, 1), midpoint = 0) +
  labs(
    title = "Correlation Between Average Pollutant Levels Across NYC Neighborhoods",
    subtitle = "Neighborhood-level means of NO2, PM2.5, and Ozone",
    x = "",
    y = "",
    fill = "Correlation"
  ) +
  theme_minimal()

fig_poll_cor



```

```{r}

library(dplyr)
library(tidyr)
library(stringr)

# Get NO2, PM2.5, and Ozone (summer only) per neighborhood
neighborhood_pollution <- clean_air %>%
  filter(
    str_detect(name, "NO2") |
    str_detect(name, "PM2.5") |
    str_detect(name, "Ozone")
  ) %>%
  mutate(
    pollutant = case_when(
      str_detect(name, "NO2") ~ "NO2",
      str_detect(name, "PM2.5") ~ "PM2.5",
      str_detect(name, "Ozone") ~ "Ozone"
    )
  ) %>%
  group_by(geo_place_name, pollutant) %>%
  summarize(mean_value = mean(data_value, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = pollutant, values_from = mean_value) %>%
  drop_na()

```

```{r}

set.seed(123)

kmeans_result <- kmeans(
  neighborhood_pollution %>% select(NO2, PM2.5, Ozone),
  centers = 3,    # number of clusters
  nstart = 25
)

neighborhood_pollution$cluster <- as.factor(kmeans_result$cluster)

```

```{r}

library(forcats)

neighborhood_pollution <- neighborhood_pollution %>%
  mutate(
    cluster = as.factor(kmeans_result$cluster),
    cluster_label = fct_recode(
      cluster,
      "Low pollution"              = "1",
      "Moderate mixed pollution"   = "2",
      "High PM2.5 & Ozone pollution" = "3"
    )
  )

```

```{r}

fig_cluster <- ggplot(neighborhood_pollution,
                      aes(x = NO2, y = PM2.5, color = cluster_label)) +
  geom_point(size = 3, alpha = 0.8) +
  labs(
    title = "K-Means Clustering of NYC Neighborhoods Based on Pollution Profile",
    subtitle = "Clusters formed using NO2, PM2.5, and Ozone (summer average)",
    x = "Average NO2 (ppb)",
    y = "Average PM2.5 (µg/m³)",
    color = "Cluster"
  )

fig_cluster
```

```{r}

library(sf)
library(dplyr)

nyc_cd <- st_read("CD.geojson")

names(nyc_cd)
head(nyc_cd)

```

```{r}
library(dplyr)
library(stringr)
library(tidyr)
library(forcats)

poll_for_cluster <- clean_air %>%
  filter(
    str_detect(name, "NO2") |
    str_detect(name, "PM2.5") |
    str_detect(name, "Ozone")
  ) %>%
  mutate(
    pollutant = case_when(
      str_detect(name, "NO2")   ~ "NO2",
      str_detect(name, "PM2.5") ~ "PM2.5",
      str_detect(name, "Ozone") ~ "Ozone"
    )
  ) %>%
  group_by(geo_join_id, geo_place_name, pollutant) %>%
  summarize(mean_value = mean(data_value, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = pollutant, values_from = mean_value) %>%
  drop_na()

set.seed(123)
kmeans_result <- kmeans(
  poll_for_cluster %>% select(NO2, `PM2.5`, Ozone),
  centers = 3,
  nstart = 25
)

poll_for_cluster <- poll_for_cluster %>%
  mutate(
    cluster = as.factor(kmeans_result$cluster),
    cluster_label = fct_recode(
      cluster,
      "Low pollution"                    = "1",
      "Moderate mixed pollution"         = "2",
      "High PM2.5 & Ozone pollution"     = "3"
    )
  )

```

```{r}

library(tidyr)

cd_clusters <- poll_for_cluster %>%
  mutate(geo_join_id = as.character(geo_join_id)) %>%
  rowwise() %>%
  mutate(cd_codes = list(str_extract_all(geo_join_id, ".{3}")[[1]])) %>%
  unnest(cd_codes) %>%
  ungroup() %>%
  mutate(GEOCODE = cd_codes) %>%   
  select(GEOCODE, cluster_label) %>%
  distinct()

```

```{r}


nyc_cd <- nyc_cd %>%
  mutate(GEOCODE = as.character(GEOCODE))

map_data <- nyc_cd %>%
  left_join(cd_clusters, by = "GEOCODE")

```

```{r}

library(ggplot2)

fig_cluster_map <- ggplot(map_data) +
  geom_sf(aes(fill = cluster_label), color = "white", size = 0.2) +
  scale_fill_manual(
    values = c(
      "Low pollution"                    = "#FFCCCB",
      "Moderate mixed pollution"         = "#66c2a5",
      "High PM2.5 & Ozone pollution"     = "#8da0cb"
    ),
    na.value = "grey90",
    breaks = c("Low pollution","Moderate mixed pollution","High PM2.5 & Ozone pollution")
  ) +
  labs(
    title = "Pollution Clusters Across NYC Community Districts",
    subtitle = "Districts colored by K-means cluster (NO2, PM2.5, and Ozone)",
    fill = "Cluster"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank()
  )

fig_cluster_map


```

